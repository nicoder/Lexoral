main:
    params: [config]
    steps:
        - vars:
            assign:
                - user_id: config.user_id
                - transcript_id: config.transcript_id
                - exec_id: ${sys.get_env("GOOGLE_CLOUD_WORKFLOW_EXECUTION_ID")}
                - function_root: ${"https://europe-west2-" + sys.get_env("GOOGLE_CLOUD_PROJECT_ID") + ".cloudfunctions.net/"}

        - align:
            call: http.get
            args:
              url: ${function_root + "align"}
              query:
                user: user_id
                transcript: transcript_id
            result: align_response
        - align_check:
            call: assert_2xx
            args:
              status: ${align_response.status}

        - adjust:
            call: http.get
            args:
              url: ${function_root + "adjust"}
              query:
                user: user_id
                transcript: transcript_id
            result: adjust_response
        - adjust_check:
            call: assert_2xx
            args:
              status: ${adjust_response.status}

        - success:
            return: "SUCCESS"

assert_2xx:
  params: [status]
  steps:
  - compare:
      switch:
      - condition: ${status >= 200 AND status < 300}
        next: end
  - fail:
      raise: ${"Expected 2xx http response, actually " + status}
